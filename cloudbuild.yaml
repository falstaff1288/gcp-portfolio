steps:
- id: 'tf init'
  name: 'hashicorp/terraform:1.5'
  entrypoint: 'sh'
  args: 
  - '-c'
  - |
      set -x
      if [ -n "$_BASE_BRANCH" ]; then
        echo "Base branch: $_BASE_BRANCH"
        case "$_BASE_BRANCH" in
          "dev")
            terraform workspace select dev
            terraform init
          ;;
          "main")
            terraform workspace select prod
            terraform init
          ;;
          *)
          ;;
        esac
      else
        echo "Branch name: $BRANCH_NAME"
        case "$BRANCH_NAME" in
          "dev")
            terraform workspace select dev
            terraform init
          ;;
          "main")
            terraform workspace select prod
            terraform init
          ;;
          *)
          ;;
        esac
      fi
# [START tf-plan]
- id: 'tf plan'
  name: 'hashicorp/terraform:1.5'
  entrypoint: 'sh'
  args: 
  - '-c'
  - |
      set -x
      if [ -n "$_BASE_BRANCH" ]; then
        echo "Base branch: $_BASE_BRANCH"
        case "$_BASE_BRANCH" in
          "dev")
            terraform workspace select dev
            terraform plan -out=/workspace/tfplan -input=false
          ;;
          "main")
            terraform workspace select prod
            terraform plan -out=/workspace/tfplan -input=false
          ;;
          *)
          ;;
        esac
      else
        echo "Branch name: $BRANCH_NAME"
        case "$BRANCH_NAME" in
          "dev")
            terraform workspace select dev
            terraform plan -out=/workspace/tfplan -input=false
          ;;
          "main")
            terraform workspace select prod
            terraform plan -out=/workspace/tfplan -input=false
          ;;
          *)
          ;;
        esac
      fi
# [END tf-plan]

# [START tf-apply]
- id: 'tf apply'
  name: 'hashicorp/terraform:1.5'
  entrypoint: 'sh'
  args: 
  - '-c'
  - |
      set -x
      if [[ "$BRANCH_NAME" == main ]] || [[ "$BRANCH_NAME" == dev ]]; then 
        case $BRANCH_NAME in
          "dev")
            if [ -n "$_BASE_BRANCH" ] && if [ "$_BASE_BRANCH" == "main" ]; then
              echo "Not applying dev"
            else
              terraform workspace select dev
              terraform apply -input=false /workspace/tfplan
            fi
          ;;
          "main")
            terraform workspace select prod
            terraform apply -input=false /workspace/tfplan
          ;;
          *)
          ;;
        esac
      else
        echo "Branch is not main or dev. No action taken."
      fi